<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plan de Entregas - Planificacion XP</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../../style.css" />
  <script src="../Historias_de_Usuario/stories.js"></script>
</head>
<body>
  <header>
    <div class="flex">
      <div class="title">Plan de Entregas</div>
      <div class="pill">Fase: Planificacion</div>
    </div>
    <nav class="nav">
      <a href="../../../index.html">Inicio</a>
      <a href="https://epnecuador-my.sharepoint.com/my?id=%2Fpersonal%2Fjuan%5Fleon01%5Fepn%5Fedu%5Fec%2FDocuments%2FEvidenciasXP&ga=1">Evidencias</a>
    </nav>
  </header>
  <main>
    <section>
      <h2>Plan de Entregas</h2>
      <p class="muted">Coloca aqui el plan de releases, hitos y fechas pactadas.</p>
    </section>

    <style>
      .plan-container {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
        margin-top: 30px;
      }

      .tareas-disponibles {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        height: fit-content;
        position: sticky;
        top: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .tareas-disponibles.drag-over-backlog {
        background: var(--panel-2);
        border-color: var(--accent);
      }

      .tareas-disponibles h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
        color: var(--text);
        font-weight: 600;
      }

      .task-card {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
        border-radius: 8px;
        padding: 12px 15px;
        margin-bottom: 10px;
        cursor: grab;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        color: #ffffff;
        position: relative;
      }

      .task-card:active {
        cursor: grabbing;
        opacity: 0.7;
      }

      .btn-eliminar {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 4px;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        color: #ffffff;
        transition: all 0.2s ease;
        padding: 0;
        line-height: 1;
      }

      .btn-eliminar:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .btn-editar {
        position: absolute;
        top: 8px;
        right: 32px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 4px;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        color: #ffffff;
        transition: all 0.2s ease;
        padding: 0;
        line-height: 1;
      }

      .btn-editar:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      }

      .task-card .release-number {
        font-size: 11px;
        font-weight: 600;
        opacity: 0.9;
        margin-bottom: 4px;
        color: #ffffff;
      }

      .task-card .objetivo {
        font-size: 14px;
        font-weight: 600;
        margin: 0 0 8px 0;
        color: #ffffff;
      }

      .task-card .hu-toggle {
        background: rgba(255, 255, 255, 0.15);
        border: none;
        border-radius: 4px;
        padding: 6px 10px;
        color: #ffffff;
        font-size: 11px;
        cursor: pointer;
        width: 100%;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
        margin-top: 4px;
      }

      .task-card .hu-toggle:hover {
        background: rgba(255, 255, 255, 0.25);
      }

      .task-card .hu-list {
        display: none;
        margin-top: 6px;
        padding-left: 0;
        list-style: none;
      }

      .task-card .hu-list.open {
        display: block;
      }

      .task-card .hu-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 6px 8px;
        margin-bottom: 4px;
        border-radius: 4px;
        font-size: 11px;
        color: #ffffff;
      }

      .task-card .hu-item strong {
        display: block;
        margin-bottom: 2px;
      }

      .calendario {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .calendario h3 {
        margin: 0 0 20px 0;
        font-size: 18px;
        color: var(--text);
        font-weight: 600;
      }

      .meses-grid {
        display: grid;
        gap: 20px;
      }

      .mes-section {
        background: var(--panel-2);
        border-radius: 8px;
        padding: 15px;
        border: 1px solid var(--border);
      }

      .mes-titulo {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--accent);
      }

      .dias-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
      }

      .dia-slot {
        background: var(--panel);
        border: 2px dashed var(--border);
        border-radius: 8px;
        padding: 10px;
        min-height: 100px;
        transition: all 0.3s ease;
      }

      .dia-slot.drag-over {
        background: var(--panel-2);
        border-color: var(--accent);
        border-style: solid;
      }

      .dia-header {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
        color: var(--text);
      }

      .dia-numero {
        font-size: 18px;
        font-weight: 700;
        color: var(--text);
      }

      .dia-nombre {
        font-size: 11px;
        opacity: 0.7;
        display: block;
        color: var(--muted);
      }

      .dia-tareas {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .task-card-small {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
        border-radius: 6px;
        padding: 8px 10px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        color: #ffffff;
        position: relative;
      }

      .task-card-small:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(37, 99, 235, 0.4);
      }

      .btn-eliminar-small {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 3px;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        color: #ffffff;
        transition: all 0.2s ease;
        padding: 0;
        line-height: 1;
        z-index: 10;
      }

      .btn-eliminar-small:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .btn-editar-small {
        position: absolute;
        top: 4px;
        right: 22px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 3px;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 10px;
        color: #ffffff;
        transition: all 0.2s ease;
        padding: 0;
        line-height: 1;
        z-index: 10;
      }

      .btn-editar-small:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .task-card-small .release-number {
        font-size: 10px;
        font-weight: 600;
        opacity: 0.9;
        margin-bottom: 3px;
        color: #ffffff;
      }

      .task-card-small .objetivo {
        font-size: 12px;
        font-weight: 600;
        margin: 0 0 4px 0;
        color: #ffffff;
        padding-right: 40px;
      }

      .task-card-small .hu-count {
        font-size: 10px;
        opacity: 0.9;
        color: #ffffff;
        margin-top: 2px;
      }

      .btn-agregar {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
        border: none;
        border-radius: 6px;
        padding: 10px 20px;
        color: white;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        margin-top: 10px;
        width: 100%;
        transition: all 0.3s ease;
      }

      .btn-agregar:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      }

      /* Modal */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-content {
        background: var(--panel);
        border-radius: 12px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        position: relative;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--border);
      }

      .modal-header h3 {
        margin: 0;
        color: var(--text);
        font-size: 20px;
      }

      .modal-close {
        background: var(--border);
        border: none;
        border-radius: 6px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        color: var(--muted);
        transition: all 0.2s ease;
      }

      .modal-close:hover {
        background: var(--panel-2);
        transform: scale(1.1);
      }

      .modal-section {
        margin-bottom: 16px;
      }

      .modal-section-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 6px;
        text-transform: uppercase;
      }

      .modal-section-content {
        color: var(--text);
        font-size: 14px;
        line-height: 1.5;
      }

      .modal-hu-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .modal-hu-item {
        background: var(--panel-2);
        padding: 10px 12px;
        margin-bottom: 8px;
        border-radius: 6px;
        border-left: 3px solid var(--accent);
      }

      .modal-hu-item strong {
        display: block;
        color: var(--accent);
        margin-bottom: 4px;
        font-size: 13px;
      }

      .modal-hu-item span {
        color: var(--muted);
        font-size: 13px;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid #e2e8f0;
      }

      .modal-btn {
        flex: 1;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .modal-btn-edit {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
        color: white;
      }

      .modal-btn-edit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      }

      .modal-btn-delete {
        background: #fc8181;
        color: white;
      }

      .modal-btn-delete:hover {
        background: #f56565;
        transform: translateY(-2px);
      }

      @media (max-width: 768px) {
        .plan-container {
          grid-template-columns: 1fr;
        }

        .tareas-disponibles {
          position: relative;
          top: 0;
        }

        .dias-grid {
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
      }
    </style>

    <div class="plan-container">
      <!-- Tareas Disponibles -->
      <div class="tareas-disponibles">
        <h3>ðŸ“‹ Tareas Disponibles</h3>
        <div id="backlog">
          <div class="task-card" draggable="true" data-id="1" data-release="Release 1.0" data-objetivo="Sprint Planning Inicial" data-historias='["HU-01","HU-02"]'>
            <button class="btn-eliminar" onclick="eliminarTarea(event, '1')">Ã—</button>
            <div class="release-number">ðŸ“¦ Release 1.0</div>
            <div class="objetivo">Sprint Planning Inicial</div>
            <button class="hu-toggle" onclick="toggleHU(event, '1')">
              <span>Historias de Usuario (2)</span>
              <span>â–¼</span>
            </button>
            <ul class="hu-list" id="hu-list-1"></ul>
          </div>
          <div class="task-card" draggable="true" data-id="2" data-release="Release 1.0" data-objetivo="ConfiguraciÃ³n del entorno" data-historias='["HU-02"]'>
            <button class="btn-eliminar" onclick="eliminarTarea(event, '2')">Ã—</button>
            <div class="release-number">ðŸ“¦ Release 1.0</div>
            <div class="objetivo">ConfiguraciÃ³n del entorno</div>
            <button class="hu-toggle" onclick="toggleHU(event, '2')">
              <span>Historias de Usuario (1)</span>
              <span>â–¼</span>
            </button>
            <ul class="hu-list" id="hu-list-2"></ul>
          </div>
          <div class="task-card" draggable="true" data-id="3" data-release="Release 1.1" data-objetivo="DiseÃ±o de interfaces" data-historias='["HU-03","HU-04"]'>
            <button class="btn-eliminar" onclick="eliminarTarea(event, '3')">Ã—</button>
            <div class="release-number">ðŸ“¦ Release 1.1</div>
            <div class="objetivo">DiseÃ±o de interfaces</div>
            <button class="hu-toggle" onclick="toggleHU(event, '3')">
              <span>Historias de Usuario (2)</span>
              <span>â–¼</span>
            </button>
            <ul class="hu-list" id="hu-list-3"></ul>
          </div>
          <div class="task-card" draggable="true" data-id="4" data-release="Release 2.0" data-objetivo="Desarrollo Backend" data-historias='["HU-05","HU-06"]'>
            <button class="btn-eliminar" onclick="eliminarTarea(event, '4')">Ã—</button>
            <div class="release-number">ðŸ“¦ Release 2.0</div>
            <div class="objetivo">Desarrollo Backend</div>
            <button class="hu-toggle" onclick="toggleHU(event, '4')">
              <span>Historias de Usuario (2)</span>
              <span>â–¼</span>
            </button>
            <ul class="hu-list" id="hu-list-4"></ul>
          </div>
        </div>
        <button class="btn-agregar" onclick="agregarNuevaTarea()">+ Agregar Tarea</button>
      </div>

      <!-- Calendario -->
      <div class="calendario">
        <h3>ðŸ“… Calendario de Entregas</h3>
        <div class="meses-grid">
          <!-- Diciembre 2025 -->
          <div class="mes-section">
            <div class="mes-titulo">Diciembre 2025</div>
            <div class="dias-grid" id="diciembre-dias"></div>
          </div>
          <!-- Enero 2026 -->
          <div class="mes-section">
            <div class="mes-titulo">Enero 2026</div>
            <div class="dias-grid" id="enero-dias"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para detalles de tarea -->
    <div class="modal-overlay" id="taskModal" onclick="cerrarModalSiFueraDeContenido(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3>Detalles del Release</h3>
          <button class="modal-close" onclick="cerrarModal()">Ã—</button>
        </div>
        <div id="modalBody"></div>
      </div>
    </div>

    <script>
      // Tareas predefinidas estÃ¡ticas para el calendario
      const tareasEstaticas = {
        '2026-01-01': {
          id: 'static-1',
          release: 'Release 1.0',
          objetivo: 'Tener el sistema base funcional y la carga de datos y la autenticacion',
          historias: ['HU-01', 'HU-02']
        },
        '2026-01-02': {
          id: 'static-2',
          release: 'Release 2.0',
          objetivo: 'Implementar la inteligencia del sistema, la logica de automatas BBA y la jerarquia de clases hormiga',
          historias: ['HU-03', 'HU-04']
        },
        '2026-01-03': {
          id: 'static-3',
          release: 'Release 3.0',
          objetivo: 'Implementar la funcionalidad de la interfaz de combate, entremiento de idiomas y hormiguero virtual',
          historias: ['HU-05', 'HU-06', 'HU-07']
        }
      };

      // Generar dÃ­as del calendario
      const diasSemana = ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'];
      
      function generarDias() {
        // Diciembre 2025 (26-31)
        const diciembreContainer = document.getElementById('diciembre-dias');
        for (let dia = 26; dia <= 31; dia++) {
          const fecha = new Date(2025, 11, dia); // 11 = diciembre
          const diaSemana = diasSemana[fecha.getDay()];
          diciembreContainer.appendChild(crearDiaSlot(dia, diaSemana, '2025-12'));
        }

        // Enero 2026 (1-10)
        const eneroContainer = document.getElementById('enero-dias');
        for (let dia = 1; dia <= 10; dia++) {
          const fecha = new Date(2026, 0, dia); // 0 = enero
          const diaSemana = diasSemana[fecha.getDay()];
          eneroContainer.appendChild(crearDiaSlot(dia, diaSemana, '2026-01'));
        }
      }

      function crearDiaSlot(dia, diaSemana, mesAno) {
        const slot = document.createElement('div');
        slot.className = 'dia-slot';
        slot.dataset.fecha = `${mesAno}-${String(dia).padStart(2, '0')}`;
        
        slot.innerHTML = `
          <div class="dia-header">
            <span class="dia-numero">${dia}</span>
            <span class="dia-nombre">${diaSemana}</span>
          </div>
          <div class="dia-tareas"></div>
        `;

        // Event listeners para drag & drop
        slot.addEventListener('dragover', handleDragOver);
        slot.addEventListener('drop', handleDrop);
        slot.addEventListener('dragleave', handleDragLeave);

        return slot;
      }

      // Funcionalidad Drag & Drop
      let draggedElement = null;

      // Event listeners para las tareas
      function setupDragListeners() {
        document.querySelectorAll('.task-card, .task-card-small').forEach(card => {
          card.addEventListener('dragstart', handleDragStart);
          card.addEventListener('dragend', handleDragEnd);
        });

        // Agregar listeners a toda el Ã¡rea de tareas disponibles
        const tareasDisponibles = document.querySelector('.tareas-disponibles');
        tareasDisponibles.addEventListener('dragover', handleBacklogDragOver);
        tareasDisponibles.addEventListener('drop', handleBacklogDrop);
        tareasDisponibles.addEventListener('dragleave', handleBacklogDragLeave);
      }

      function handleDragStart(e) {
        draggedElement = e.target;
        e.target.style.opacity = '0.4';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.target.innerHTML);
      }

      function handleDragEnd(e) {
        e.target.style.opacity = '1';
      }

      // Drag & Drop para el backlog (devolver tareas)
      function handleBacklogDragOver(e) {
        // Solo aceptar tareas del calendario
        if (draggedElement && draggedElement.classList.contains('task-card-small')) {
          if (e.preventDefault) {
            e.preventDefault();
          }
          e.dataTransfer.dropEffect = 'move';
          e.currentTarget.classList.add('drag-over-backlog');
        }
        return false;
      }

      function handleBacklogDragLeave(e) {
        // Verificar que realmente salimos del contenedor
        if (e.currentTarget.contains(e.relatedTarget)) {
          return;
        }
        e.currentTarget.classList.remove('drag-over-backlog');
      }

      function handleBacklogDrop(e) {
        if (e.stopPropagation) {
          e.stopPropagation();
        }

        const tareasDisponibles = e.currentTarget;
        tareasDisponibles.classList.remove('drag-over-backlog');

        if (draggedElement && draggedElement.classList.contains('task-card-small')) {
          // Solo si viene del calendario (task-card-small)
          const taskData = {
            id: draggedElement.dataset.id || Date.now(),
            release: draggedElement.dataset.release || 'Release 1.0',
            objetivo: draggedElement.querySelector('.objetivo')?.textContent || 'Sin objetivo',
            historias: draggedElement.dataset.historias || '[]'
          };

          const historiasArray = JSON.parse(taskData.historias);
          const huCount = historiasArray.length;

          // Crear tarjeta grande en el backlog
          const backlog = document.getElementById('backlog');
          const newCard = document.createElement('div');
          newCard.className = 'task-card';
          newCard.draggable = true;
          newCard.dataset.id = taskData.id;
          newCard.dataset.release = taskData.release;
          newCard.dataset.objetivo = taskData.objetivo;
          newCard.dataset.historias = taskData.historias;
          newCard.innerHTML = `
            <button class="btn-editar" onclick="editarTarea(event, '${taskData.id}')">âœŽ</button>
            <button class="btn-eliminar" onclick="eliminarTarea(event, '${taskData.id}')">Ã—</button>
            <div class="release-number">ðŸ“¦ ${taskData.release}</div>
            <div class="objetivo">${taskData.objetivo}</div>
            <button class="hu-toggle" onclick="toggleHU(event, '${taskData.id}')">
              <span>Historias de Usuario (${huCount})</span>
              <span>â–¼</span>
            </button>
            <ul class="hu-list" id="hu-list-${taskData.id}"></ul>
          `;

          backlog.appendChild(newCard);
          renderHUList(taskData.id, historiasArray);

          // Eliminar del calendario
          draggedElement.remove();

          // Reconfigurar listeners
          setupDragListeners();
          guardarEstado();
        }

        return false;
      }

      // Drag & Drop para los dÃ­as del calendario
      function handleDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        
        const slot = e.currentTarget;
        slot.classList.add('drag-over');
        
        return false;
      }

      function handleDragLeave(e) {
        e.currentTarget.classList.remove('drag-over');
      }

      function handleDrop(e) {
        if (e.stopPropagation) {
          e.stopPropagation();
        }

        const slot = e.currentTarget;
        slot.classList.remove('drag-over');

        if (draggedElement) {
          // Crear una versiÃ³n pequeÃ±a de la tarea
          const taskData = {
            id: draggedElement.dataset.id || Date.now(),
            release: draggedElement.dataset.release || 'Release 1.0',
            objetivo: draggedElement.querySelector('.objetivo')?.textContent || 'Sin objetivo',
            historias: draggedElement.dataset.historias || '[]'
          };

          const historiasArray = JSON.parse(taskData.historias);
          const huCount = historiasArray.length;

          // Agregar al dÃ­a
          const tareasContainer = slot.querySelector('.dia-tareas');
          const newCard = document.createElement('div');
          newCard.className = 'task-card-small';
          newCard.draggable = true;
          newCard.dataset.id = taskData.id;
          newCard.dataset.release = taskData.release;
          newCard.dataset.objetivo = taskData.objetivo;
          newCard.dataset.historias = taskData.historias;
          newCard.innerHTML = `
            <button class="btn-editar-small" onclick="editarTarea(event, '${taskData.id}')">âœŽ</button>
            <button class="btn-eliminar-small" onclick="eliminarTarea(event, '${taskData.id}')">Ã—</button>
            <div class="release-number">ðŸ“¦ ${taskData.release}</div>
            <div class="objetivo">${taskData.objetivo}</div>
            <div class="hu-count">ðŸ“„ ${huCount} Historia${huCount !== 1 ? 's' : ''}</div>
          `;

          // Click para abrir modal
          newCard.addEventListener('click', (e) => {
            if (!e.target.classList.contains('btn-editar-small') && 
                !e.target.classList.contains('btn-eliminar-small')) {
              abrirModal(taskData.id);
            }
          });

          tareasContainer.appendChild(newCard);

          // Si viene del backlog, removerlo
          if (draggedElement.parentElement.id === 'backlog') {
            draggedElement.remove();
          } else {
            // Si viene de otro dÃ­a, moverlo
            draggedElement.remove();
          }

          // Reconfigurar listeners
          setupDragListeners();
          guardarEstado();
        }

        return false;
      }

      // Editar tarea
      function editarTarea(event, taskId) {
        event.stopPropagation();
        event.preventDefault();
        
        const taskElement = document.querySelector(`[data-id="${taskId}"]`);
        if (!taskElement) return;
        
        // Verificar si es una tarea estÃ¡tica
        if (taskElement.dataset.estatica === 'true') {
          alert('No se pueden editar las tareas predefinidas del sistema.');
          return;
        }

        const releaseActual = taskElement.dataset.release;
        const objetivoActual = taskElement.dataset.objetivo;
        const historiasActuales = JSON.parse(taskElement.dataset.historias || '[]');

        // Editar Release
        const nuevoRelease = prompt('NÂ° Release:', releaseActual);
        if (nuevoRelease === null) return;

        // Editar Objetivo
        const nuevoObjetivo = prompt('Objetivo:', objetivoActual);
        if (nuevoObjetivo === null) return;

        // Editar Historias de Usuario
        const storiesAvailable = window.stories || [];
        if (storiesAvailable.length === 0) {
          alert('No hay historias de usuario disponibles');
          return;
        }

        const storiesText = storiesAvailable.map((s, i) => `${i + 1}. ${s.id} - ${s.title}`).join('\n');
        const historiasActualesText = historiasActuales.join(', ');
        const seleccion = prompt(`Historias actuales: ${historiasActualesText}\n\nHistorias disponibles:\n${storiesText}\n\nIngresa los nÃºmeros separados por comas (ej: 1,3,5):`, '');
        if (seleccion === null) return;

        const indices = seleccion.split(',').map(n => parseInt(n.trim()) - 1).filter(i => i >= 0 && i < storiesAvailable.length);
        const nuevasHistorias = indices.map(i => storiesAvailable[i].id);

        if (nuevasHistorias.length === 0) {
          alert('No se seleccionaron historias vÃ¡lidas');
          return;
        }

        // Actualizar datos
        taskElement.dataset.release = nuevoRelease;
        taskElement.dataset.objetivo = nuevoObjetivo;
        taskElement.dataset.historias = JSON.stringify(nuevasHistorias);

        // Actualizar UI
        const esGrande = taskElement.classList.contains('task-card');
        const huCount = nuevasHistorias.length;
        
        taskElement.innerHTML = `
          ${esGrande ? 
            `<button class="btn-editar" onclick="editarTarea(event, '${taskId}')">âœŽ</button>
             <button class="btn-eliminar" onclick="eliminarTarea(event, '${taskId}')">Ã—</button>` :
            `<button class="btn-editar-small" onclick="editarTarea(event, '${taskId}')">âœŽ</button>
             <button class="btn-eliminar-small" onclick="eliminarTarea(event, '${taskId}')">Ã—</button>`
          }
          <div class="release-number">ðŸ“¦ ${nuevoRelease}</div>
          <div class="objetivo">${nuevoObjetivo}</div>
          <button class="hu-toggle" onclick="toggleHU(event, '${taskId}')">
            <span>${esGrande ? 'Historias de Usuario' : 'HU'} (${huCount})</span>
            <span>â–¼</span>
          </button>
          <ul class="hu-list" id="hu-list-${taskId}"></ul>
        `;

        renderHUList(taskId, nuevasHistorias);
        setupDragListeners();
        guardarEstado();
      }

      // Eliminar tarea
      function eliminarTarea(event, taskId) {
        event.stopPropagation();
        event.preventDefault();
        
        // Buscar la tarea
        const taskElement = document.querySelector(`[data-id="${taskId}"]`);
        if (!taskElement) return;
        
        // Verificar si es una tarea estÃ¡tica
        if (taskElement.dataset.estatica === 'true') {
          alert('No se pueden eliminar las tareas predefinidas del sistema.');
          return;
        }
        
        if (confirm('Â¿EstÃ¡s seguro de que deseas eliminar esta tarea?')) {
          taskElement.remove();
          guardarEstado();
        }
      }

      // Agregar nueva tarea
      let contadorTareas = 9;
      function agregarNuevaTarea() {
        const release = prompt('NÂ° Release (ej: Release 1.0):');
        if (!release) return;
        
        const objetivo = prompt('Objetivo del Release:');
        if (!objetivo) return;

        // Mostrar historias disponibles
        const storiesAvailable = window.stories || [];
        if (storiesAvailable.length === 0) {
          alert('No hay historias de usuario disponibles');
          return;
        }

        const storiesText = storiesAvailable.map((s, i) => `${i + 1}. ${s.id} - ${s.title}`).join('\n');
        const seleccion = prompt(`Historias de Usuario disponibles:\n${storiesText}\n\nIngresa los nÃºmeros separados por comas (ej: 1,3,5):`);
        if (!seleccion) return;

        const indices = seleccion.split(',').map(n => parseInt(n.trim()) - 1).filter(i => i >= 0 && i < storiesAvailable.length);
        const historiasSeleccionadas = indices.map(i => storiesAvailable[i].id);

        if (historiasSeleccionadas.length === 0) {
          alert('No se seleccionaron historias vÃ¡lidas');
          return;
        }

        const backlog = document.getElementById('backlog');
        const newCard = document.createElement('div');
        newCard.className = 'task-card';
        newCard.draggable = true;
        const nuevoId = contadorTareas++;
        newCard.dataset.id = nuevoId;
        newCard.dataset.release = release;
        newCard.dataset.objetivo = objetivo;
        newCard.dataset.historias = JSON.stringify(historiasSeleccionadas);
        newCard.innerHTML = `
          <button class="btn-editar" onclick="editarTarea(event, '${nuevoId}')">âœŽ</button>
          <button class="btn-eliminar" onclick="eliminarTarea(event, '${nuevoId}')">Ã—</button>
          <div class="release-number">ðŸ“¦ ${release}</div>
          <div class="objetivo">${objetivo}</div>
          <button class="hu-toggle" onclick="toggleHU(event, '${nuevoId}')">
            <span>Historias de Usuario (${historiasSeleccionadas.length})</span>
            <span>â–¼</span>
          </button>
          <ul class="hu-list" id="hu-list-${nuevoId}"></ul>
        `;

        backlog.appendChild(newCard);
        renderHUList(nuevoId, historiasSeleccionadas);
        setupDragListeners();
        guardarEstado();
      }

      // Guardar estado en localStorage
      function guardarEstado() {
        const estado = {
          backlog: [],
          calendario: {}
        };

        // Guardar tareas del backlog
        document.querySelectorAll('#backlog .task-card').forEach(card => {
          estado.backlog.push({
            id: card.dataset.id,
            release: card.dataset.release,
            objetivo: card.querySelector('.objetivo').textContent,
            historias: card.dataset.historias
          });
        });

        // Guardar tareas del calendario (excluir estÃ¡ticas)
        document.querySelectorAll('.dia-slot').forEach(slot => {
          const fecha = slot.dataset.fecha;
          const tareas = [];
          
          slot.querySelectorAll('.task-card-small').forEach(card => {
            // No guardar tareas estÃ¡ticas
            if (card.dataset.estatica === 'true') return;
            
            tareas.push({
              id: card.dataset.id,
              release: card.dataset.release,
              objetivo: card.querySelector('.objetivo').textContent,
              historias: card.dataset.historias
            });
          });

          if (tareas.length > 0) {
            estado.calendario[fecha] = tareas;
          }
        });

        localStorage.setItem('planDeEntregas', JSON.stringify(estado));
      }

      // Cargar estado desde localStorage
      function cargarEstado() {
        // Primero cargar tareas estÃ¡ticas
        cargarTareasEstaticas();

        const estadoGuardado = localStorage.getItem('planDeEntregas');
        if (!estadoGuardado) return;

        const estado = JSON.parse(estadoGuardado);

        // Limpiar backlog actual
        const backlog = document.getElementById('backlog');
        backlog.innerHTML = '';

        // Restaurar backlog
        estado.backlog.forEach(tarea => {
          const historiasArray = JSON.parse(tarea.historias || '[]');
          const huCount = historiasArray.length;
          
          const card = document.createElement('div');
          card.className = 'task-card';
          card.draggable = true;
          card.dataset.id = tarea.id;
          card.dataset.release = tarea.release;
          card.dataset.objetivo = tarea.objetivo;
          card.dataset.historias = tarea.historias;
          card.innerHTML = `
            <button class="btn-editar" onclick="editarTarea(event, '${tarea.id}')">âœŽ</button>
            <button class="btn-eliminar" onclick="eliminarTarea(event, '${tarea.id}')">Ã—</button>
            <div class="release-number">ðŸ“¦ ${tarea.release}</div>
            <div class="objetivo">${tarea.objetivo}</div>
            <button class="hu-toggle" onclick="toggleHU(event, '${tarea.id}')">
              <span>Historias de Usuario (${huCount})</span>
              <span>â–¼</span>
            </button>
            <ul class="hu-list" id="hu-list-${tarea.id}"></ul>
          `;
          backlog.appendChild(card);
          renderHUList(tarea.id, historiasArray);
        });

        // Restaurar calendario
        Object.keys(estado.calendario).forEach(fecha => {
          const slot = document.querySelector(`[data-fecha="${fecha}"]`);
          if (!slot) return;

          const tareasContainer = slot.querySelector('.dia-tareas');
          tareasContainer.innerHTML = '';

          estado.calendario[fecha].forEach(tarea => {
            const historiasArray = JSON.parse(tarea.historias || '[]');
            const huCount = historiasArray.length;
            
            const card = document.createElement('div');
            card.className = 'task-card-small';
            card.draggable = true;
            card.dataset.id = tarea.id;
            card.dataset.release = tarea.release;
            card.dataset.objetivo = tarea.objetivo;
            card.dataset.historias = tarea.historias;
            card.innerHTML = `
              <button class="btn-editar-small" onclick="editarTarea(event, '${tarea.id}')">âœŽ</button>
              <button class="btn-eliminar-small" onclick="eliminarTarea(event, '${tarea.id}')">Ã—</button>
              <div class="release-number">ðŸ“¦ ${tarea.release}</div>
              <div class="objetivo">${tarea.objetivo}</div>
              <div class="hu-count">ðŸ“„ ${huCount} Historia${huCount !== 1 ? 's' : ''}</div>
            `;
            
            // Click para abrir modal
            card.addEventListener('click', (e) => {
              if (!e.target.classList.contains('btn-editar-small') && 
                  !e.target.classList.contains('btn-eliminar-small')) {
                abrirModal(tarea.id);
              }
            });
            
            tareasContainer.appendChild(card);
          });
        });

        setupDragListeners();
      }

      // Toggle Historias de Usuario
      function toggleHU(event, taskId) {
        event.stopPropagation();
        event.preventDefault();
        
        const list = document.getElementById(`hu-list-${taskId}`);
        if (list) {
          list.classList.toggle('open');
          const button = event.currentTarget;
          const arrow = button.querySelector('span:last-child');
          if (arrow) {
            arrow.textContent = list.classList.contains('open') ? 'â–²' : 'â–¼';
          }
        }
      }

      // Renderizar lista de Historias de Usuario
      function renderHUList(taskId, historiasIds) {
        const list = document.getElementById(`hu-list-${taskId}`);
        if (!list) return;

        const storiesData = window.stories || [];
        const historiasCompletas = historiasIds.map(id => 
          storiesData.find(s => s.id === id)
        ).filter(h => h);

        list.innerHTML = historiasCompletas.map(hu => `
          <li class="hu-item">
            <strong>${hu.id}</strong>
            ${hu.title}
          </li>
        `).join('');
      }

      // Inicializar listas de HU al cargar
      function inicializarHULists() {
        document.querySelectorAll('[data-historias]').forEach(card => {
          const historias = JSON.parse(card.dataset.historias || '[]');
          if (historias.length > 0) {
            renderHUList(card.dataset.id, historias);
          }
        });
      }

      // Cargar tareas estÃ¡ticas en el calendario
      function cargarTareasEstaticas() {
        Object.keys(tareasEstaticas).forEach(fecha => {
          const slot = document.querySelector(`[data-fecha="${fecha}"]`);
          if (!slot) return;

          const tarea = tareasEstaticas[fecha];
          const tareasContainer = slot.querySelector('.dia-tareas');
          
          // Verificar si ya existe la tarea estÃ¡tica
          const existente = tareasContainer.querySelector(`[data-id="${tarea.id}"]`);
          if (existente) return;

          const huCount = tarea.historias.length;
          
          const card = document.createElement('div');
          card.className = 'task-card-small';
          card.draggable = true;
          card.dataset.id = tarea.id;
          card.dataset.release = tarea.release;
          card.dataset.objetivo = tarea.objetivo;
          card.dataset.historias = JSON.stringify(tarea.historias);
          card.dataset.estatica = 'true';
          card.innerHTML = `
            <button class="btn-editar-small" onclick="editarTarea(event, '${tarea.id}')">âœŽ</button>
            <button class="btn-eliminar-small" onclick="eliminarTarea(event, '${tarea.id}')">Ã—</button>
            <div class="release-number">ðŸ“¦ ${tarea.release}</div>
            <div class="objetivo">${tarea.objetivo}</div>
            <div class="hu-count">ðŸ“„ ${huCount} Historia${huCount !== 1 ? 's' : ''}</div>
          `;
          
          // Click para abrir modal
          card.addEventListener('click', (e) => {
            if (!e.target.classList.contains('btn-editar-small') && 
                !e.target.classList.contains('btn-eliminar-small')) {
              abrirModal(tarea.id);
            }
          });
          
          tareasContainer.appendChild(card);
        });
      }

      // Funciones del Modal
      function abrirModal(taskId) {
        const taskElement = document.querySelector(`[data-id="${taskId}"]`);
        if (!taskElement) return;

        const release = taskElement.dataset.release;
        const objetivo = taskElement.dataset.objetivo;
        const historiasIds = JSON.parse(taskElement.dataset.historias || '[]');

        const storiesData = window.stories || [];
        const historiasCompletas = historiasIds.map(id => 
          storiesData.find(s => s.id === id)
        ).filter(h => h);

        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = `
          <div class="modal-section">
            <div class="modal-section-title">NÂ° Release</div>
            <div class="modal-section-content">ðŸ“¦ ${release}</div>
          </div>
          <div class="modal-section">
            <div class="modal-section-title">Objetivo</div>
            <div class="modal-section-content">${objetivo}</div>
          </div>
          <div class="modal-section">
            <div class="modal-section-title">Historias de Usuario (${historiasCompletas.length})</div>
            <ul class="modal-hu-list">
              ${historiasCompletas.map(hu => `
                <li class="modal-hu-item">
                  <strong>${hu.id}</strong>
                  <span>${hu.title}</span>
                </li>
              `).join('')}
            </ul>
          </div>
          <div class="modal-actions">
            <button class="modal-btn modal-btn-edit" onclick="editarDesdeModal('${taskId}')">
              âœŽ Editar
            </button>
            <button class="modal-btn modal-btn-delete" onclick="eliminarDesdeModal('${taskId}')">
              ðŸ—‘ Eliminar
            </button>
          </div>
        `;

        document.getElementById('taskModal').classList.add('active');
      }

      function cerrarModal() {
        document.getElementById('taskModal').classList.remove('active');
      }

      function cerrarModalSiFueraDeContenido(event) {
        if (event.target.id === 'taskModal') {
          cerrarModal();
        }
      }

      function editarDesdeModal(taskId) {
        cerrarModal();
        const event = new Event('click');
        editarTarea(event, taskId);
      }

      function eliminarDesdeModal(taskId) {
        cerrarModal();
        const event = new Event('click');
        eliminarTarea(event, taskId);
      }

      // Cerrar modal con tecla ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          cerrarModal();
        }
      });

      // Inicializar
      generarDias();
      cargarTareasEstaticas(); // Cargar tareas estÃ¡ticas primero
      cargarEstado(); // Luego cargar estado guardado
      setupDragListeners();
      inicializarHULists();

      // Guardar automÃ¡ticamente cada minuto
      setInterval(guardarEstado, 60000);
    </script>
  </main>
</body>
</html>
